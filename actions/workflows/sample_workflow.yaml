---
version: 1.0
description: sample workflow

input:
  - user
  - executionid: <% ctx(st2).action_execution_id %>

vars:
  - actionresult: 'nil'
  # Datadog Logging
  - alert_type: 'info'
  - metric: 'nil'

tasks:

  logexecutonid:
    action: core.local
    input:
      cmd: >
        echo 'logging execution Id';
    next:
      - when: <% succeeded() %>
        publish: 
          - actionresult: "executionid: <% ctx().executionid %>"
        do: 
          - post_datadaog_event
          - python_script_runner

  python_script_runner:
    action: fgid_00423_dev_automation.sample_python_runner
    input:
      user: <% ctx().user %>
    next:
      - when: <% succeeded() %>
        publish:
          - actionresult: "python_script_runner:<% task(python_script_runner).result %>"
          - alert_type: "info"
        do:
          - shell_script_runner
          - post_datadaog_event
      - when: <% failed() %>
        publish:
          - actionresult: "python_script_runner:<% task(python_script_runner).result %>"
          - alert_type: "error"
        do: 
          - post_datadaog_event
  
  shell_script_runner:
    action: fgid_00423_dev_automation.sample_shell_script_runner
    input:
      user: <% ctx().user %>
    next:
      - when: <% succeeded() %>
        publish:
          - actionresult: "shell_script_runner:<% task(shell_script_runner).result %>"
          - alert_type: "info"
        do:
          - post_datadaog_event
      - when: <% failed() %>
        publish:
          - actionresult: "shell_script_runner:<% task(shell_script_runner).result %>"
          - alert_type: "error"
        do: 
          - post_datadaog_event

  post_datadaog_event:
    action: sbuxcoreutils.post_datadog_event #action
    input: #parameters
      alert_type: <% ctx().alert_type %>
      pack: <% ctx(st2).pack %>
      text: <% ctx().actionresult %>
      title: "Sample Workflow Automation"
      tags: [executionid:<% ctx().executionid %>,pack:<% ctx(st2).pack %>] 
